name: Check Broken Links

on:
  pull_request:
    branches: [main]
    paths:
      - 'docs/**'
      - 'i18n/**'
      - 'src/**'
      - 'docusaurus.config.js'
      - 'sidebars.js'

jobs:
  check-links:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    strategy:
      matrix:
        locale: [en, es, ja, ko]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Check broken links for ${{ matrix.locale }}
        id: check-links
        run: |
          echo "ðŸ” Checking broken links for locale: ${{ matrix.locale }}"
          
          # Build with strict link checking
          BUILD_ARGS="docusaurus build"
          if [ "${{ matrix.locale }}" != "en" ]; then
            BUILD_ARGS="$BUILD_ARGS --locale ${{ matrix.locale }}"
          fi
          
          # Capture build output
          set +e
          yarn $BUILD_ARGS 2>&1 | tee build-output.txt
          BUILD_EXIT_CODE=${PIPESTATUS[0]}
          set -e
          
          # Parse broken links from output
          BROKEN_LINKS=$(grep -E "(Broken link|broken link)" build-output.txt || true)
          
          if [ $BUILD_EXIT_CODE -ne 0 ] && [ -n "$BROKEN_LINKS" ]; then
            echo "has_broken=true" >> $GITHUB_OUTPUT
            echo "broken_links<<EOF" >> $GITHUB_OUTPUT
            echo "$BROKEN_LINKS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_broken=false" >> $GITHUB_OUTPUT
          fi
          
          exit $BUILD_EXIT_CODE
        env:
          DOCUSAURUS_BROKEN_LINKS: throw
          DOCUSAURUS_BROKEN_MARKDOWN_LINKS: throw
          MENDABLE_KEY: ${{ secrets.MENDABLE_KEY }}
          COOKBOOK_PUBLIC_API_KEY: ${{ secrets.COOKBOOK_PUBLIC_API_KEY }}
          GTM_CONTAINER_ID: ${{ secrets.GTM_CONTAINER_ID }}

      - name: Create comment body
        if: failure() && steps.check-links.outputs.has_broken == 'true'
        run: |
          cat << 'EOF' > broken-links-comment.md
          ## ðŸ”— Broken Links Found in ${{ matrix.locale }}
          
          The build failed due to broken internal links.
          
          <details>
          <summary>View broken links</summary>
          
          ```
          ${{ steps.check-links.outputs.broken_links }}
          ```
          
          </details>
          
          ---
          **How to fix:**
          1. Check if the linked page exists
          2. Update the link to the correct URL
          3. If the page was moved, update to the new location
          4. If the page was deleted, remove the link
          EOF

      - name: Comment on PR
        if: failure() && steps.check-links.outputs.has_broken == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('broken-links-comment.md', 'utf8');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
